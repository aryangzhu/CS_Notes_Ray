# 走入并行

## 必须知道的几个概念

### 同步和异步

同步:串行执行，必须得等前面的执行完以后后面的任务才能执行。

异步:调用方法后立即返回，然后调用者可以立即执行后面的任务，而等被调用的方法完成之后会通知调用者。

### 并发与并行

并发:短时间内还是串行。

并行:真正意义上的同时执行。

### 临界区

多个线程共享的公共资源或者是共享数据。每一次只能有一个线程占用。

### 阻塞与非阻塞

阻塞:如果其他线程占用了临界区资源，那么当前线程会在临界区挂起,这种情况称为阻塞。

### 死锁、饥饿、活锁

#### 死锁

死锁:如果多个线程循环等待,那么就会出现死锁。

死锁产生的三个条件:

1.互斥条件：同一资源同一时刻只能被一个线程占有。

2.请求与保持条件：拿到了资源以后,如果因为请求资源而阻塞,那么就会持有资源不释放。

3.不可剥夺条件:资源在被一个线程拿走之后，其他线程就不能剥夺这个线程的资源。

4.循环等待条件:线程之间会等待其他线程的资源从而形成一个等待循环。

破坏死锁:

1.破坏请求与保持条件:一次性申请所有资源。

2.破坏不可剥夺条件:占用部分资源的线程去申请其他资源，如果申请不到的话那么就释放掉持有的资源。

3.破坏循环等待条件:按序申请资源,资源反序释放。这样就能保证一个线程从头到尾获得资源。

#### 饥饿

某一线程或者多个线程以为请求不到资源导致一直无法运行(猜测是以时间来判断???),比如因为线程优先级过低，一直有高优先级线程执行。

#### 活锁

活锁则是因为过于“谦让“而导致线程无法拿到全部资源。想象的场景是:两个人不停为对方让路。

## 并发级别

### 阻塞

采用的是悲观策略。

### 无饥饿

尽量采用公平的线程队列，好让所有线程都能够有机会执行。

### 无障碍

首先是一种乐观的策略,所有线程都可以进入临界区,当多个线程共同修改数据而导致数据破坏时会采用**回滚**策略(侧面也可以看出这种级别认为不会有过多的线程同时修改资源导致并发问题)。

可行的无障碍实现是依赖一个"一致性标记"来实现。线程在操作之前,先读取并保存这个标记,在操作完成以后,再次读取，检查这个标记是否被修改过。

### 无锁

无锁是无障碍的。

无锁会有多个线程在临界区内修改资源,但是总有一个会成功???

### 无等待

无等待要求线程在有限步内完成操作,这样不会引起饥饿问题(饥饿就是因为一直不执行)。

典型的无等待结构RCU(Read-Copy-Update)。它的基本思想是,对数据的读不加修改。因此,所有的线程都是无等待的,它们既不会被锁定等待也不会引起任何冲突。

## 并行有关的两个定律

### Amdahal定律

### Gustafson定律

## 回到Java:JMM

JMM:Java内存模型。由于Java并发的复杂性,所以导致了线程不安全的问题,如何保证下面这些特性也是我们关注的重点:

### 原子性(Atomicity)

指的是一个操作还没完成前,其他线程无法干扰。如果Java虚拟机是32位的话,那么long类型的变量赋值就有可能发生问题(因为long类型是64位,我猜测需要两个线程来完成赋值操作???),所以就会导致值和预期不一致的情况。

### 可见性(Visibility)

如果在一个线程中修改了某个变量的值,其他共享的线程是否知道。一般来说,其他线程观察当前线程(是否观察到、何时观察到)是无法保证的。

### 有序性(Ordering)

按照书上的说法来说,干扰有序性的主要因素就是指令重排。指令重排出现的问题就是减少操作系统**流水线**机制的中断从而提升性能。指令重排也得满足**语义串行性**,但是没有义务保证多线程间的语义也一致(书上的例子是线程1给a赋值,线程2对a的值做修改,但是线程2有可能先执行)。

#### 哪些指令不能重排

##### 程序顺序原则

一个线程内保证语义的串行性

##### volatile规则

**volatile变量**的写,先发生于读,这保证了volatile变量的可见性

##### 锁规则

解锁(unlock)必然发生在随后的加锁前。

###### 传递性

a=b; b=c;

A必然要先于C

##### 线程的start()先于它的每一个动作

也就是说start方法会先执行。

##### 线程的所有操作先于线程的终结(Thread.join())

##### 线程的中断(interrupt())先于被中断线程的代码

##### 对象的构造函数执行、结束于finalize()方法

finalize()方法在JVM中看到过,可达性分析时会有一次标记,实例在finalize()方法中可以拯救自己一次(和可达链搭上关系)。

# Java并行程序基础

## 有关线程必知的事

### 进程

资源分配和调度的基本单位。

线程是程序的最小执行单位。

线程的状态6种，记住并且能说出具体干了什么。

## 初始线程：线程的基本状态





